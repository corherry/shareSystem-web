<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>发表问题 编辑问题 公用</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="fly,layui,前端社区">
  <meta name="description" content="Fly社区是模块化前端UI框架Layui的官网社区，致力于为web开发提供强劲动力">
  <link rel="stylesheet" href="../resources/layui/css/layui.css">
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/add.css">
  <link rel="stylesheet" href="../css/jquery.atwho.css">
</head>

<body>

  <div class="fly-header layui-bg-black">
    <div class="layui-container">
      <a class="fly-logo" href="index.html">
        <img src="../images/logo-min.png" alt="layui">
      </a>

      <div class="layui-form component">
        <input type="text" placeholder="搜索帖子或用户" value="" class="layui-input" id="search_text">
      </div>

      <div class="layui-form search">
        <select name="searchType" lay-verify="required" id="search_select">
          <option value="1" select="">帖子</option>
          <option value="2">用户</option>
        </select>
      </div>

      <div class="search-icon">
        <span class="fly-search">
          <i class="layui-icon" onclick="search()"></i>
        </span>
      </div>


      <ul class="layui-nav fly-nav-user">

        <li class="layui-nav-item">
          <a class="fly-nav-avatar" href="javascript:;" id="headUser">

            <img src="../images/default_userHeadPic.gif" id="head_userPic">&nbsp;&nbsp;

            <cite class="layui-hide-xs" id="head_username"></cite>
          </a>
          <dl class="layui-nav-child">
            <dd>
              <a href="home.html">
                <i class="layui-icon" style="margin-left: 2px; font-size: 22px;">&#xe68e;</i>我的主页</a>
            </dd>
            <dd>
              <a href="userCenter.html">
                <i class="layui-icon" style="margin-left: 2px; font-size: 22px;">&#xe612;</i>用户中心</a>
            </dd>
            <dd>
              <a href="set.html">
                <i class="layui-icon">&#xe620;</i>基本设置</a>
            </dd>
            <!-- <dd>
              <a href="message.html">
                <i class="iconfont icon-tongzhi" style="top: 4px;"></i>我的消息</a>
            </dd> -->

            <hr style="margin: 5px 0;">
            <dd>
              <a style="text-align: center;" onclick="logout()">退出</a>
            </dd>
          </dl>
        </li>

      </ul>
    </div>
  </div>

  <div class="layui-container fly-marginTop">
    <div class="fly-panel" pad20 style="padding-top: 5px;">
      <!--<div class="fly-none">没有权限</div>-->
      <div class="layui-form layui-form-pane">
        <div class="layui-tab layui-tab-brief" lay-filter="user">
          <ul class="layui-tab-title">
            <li class="layui-this">发表新帖
              <!-- 编辑帖子 -->
            </li>
          </ul>
          <div class="layui-form layui-tab-content" id="LAY_ucm" style="padding: 20px 0;">
            <div class="layui-tab-item layui-show">
              <form class="layui-form">
                <div class="layui-row layui-col-space15 layui-form-item">
                  <div class="layui-col-md3">
                    <label class="layui-form-label">所在专栏</label>
                    <div class="layui-input-block">
                      <select lay-verify="required" name="topicClassId" lay-filter="column" id="topic_class">
                        <option></option>
                      </select>
                    </div>
                  </div>
                  <div class="layui-col-md9">
                    <label for="L_title" class="layui-form-label">标题</label>
                    <div class="layui-input-block">
                      <input type="text" id="L_title" name="title" required lay-verify="required" autocomplete="off" class="layui-input" maxlength="20">
                      <!-- <input type="hidden" name="id" value="{{d.edit.id}}"> -->
                    </div>
                  </div>
                </div>
                <div class="layui-form-item layui-form-text">
                  <div class="layui-input-block">
                    <textarea id="L_content" name="content" required lay-verify="required|content" placeholder="详细描述" class="layui-textarea"
                      style="height: 260px;" maxlength="200"></textarea>
                  </div>
                </div>
                <div class="layui-form-item">
                  &nbsp;
                  <a>
                    <i class="layui-icon face" style="font-size: 25px; color: orange">&#xe60c;</i>
                  </a>&nbsp;&nbsp;
                  <a id="btn">
                    <i class="layui-icon icon_emot_photo_video icon_photo" style="font-size: 25px; color: green">&#xe64a;</i>
                  </a>
                  <div id="html5_1ccsdu84ne2v8f3e6esrk13sn7_container" class="moxie-shim moxie-shim-html5" style="position: relative; top: 0px; left: -30px; width: 28px; height: 20px; overflow: hidden; z-index: 0; display: inline-block;">
                    <input id="html5_1ccsdu84ne2v8f3e6esrk13sn7" type="file" style="font-size: 999px; opacity: 0; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;"
                      multiple="" accept="image/jpeg,image/png,image/gif">
                  </div>
                  <div style="width: 400px;display: inline-block;float:right">
                    <div class="layui-input-block" style="display: inline-block;">
                      <select lay-verify="required" name="authority" lay-filter="column">
                        <option value="3" selected>所有人可见</option>
                        <option value="2">仅好友可见</option>
                        <option value="1">仅自己可见</option>
                      </select>
                    </div>

                    <button id="btn_publish" class="layui-btn" lay-filter="publish" lay-submit style="float: right;display: inline-block;">立即发布</button>
                  </div>
                </div>

              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="fly-footer">
    <p>
      <a href="#" target="_blank">Copyright © 2018 北京理工大学珠海学院、Marjane</a>
    </p>
  </div>

  <div class="photo_upload_box_outside" id="photo_upload_box_outside" tabindex="2000">
    <div class="photo_upload_box">
      <a class="photo_upload_close" href="javascript:void(0);" onclick="photo_upload_close()"></a>
      <h1>本地上传</h1>
      <p class="upload_num">共
        <span id="uploaded_length">0</span>张，还能上传
        <span id="upload_other">9</span>张</p>
      <ul id="ul_pics" class="ul_pics clearfix">
        <li id="local_upload">
          <img src="../images/local_upload.png" id="btn2" style="position: relative; z-index: 1;">
          <div id="html5_1ccr1dmlohc912u69e0s731cvo3_container" class="moxie-shim moxie-shim-html5" style="position: absolute; top: 0px; left: 0px; width: 0px; height: 0px; overflow: hidden; z-index: 0;">
            <input id="html5_1ccr1dmlohc912u69e0s731cvo3" type="file" style="font-size: 999px; opacity: 0; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;"
              multiple="" accept="image/jpeg,image/png,image/gif">
          </div>
        </li>
      </ul>
      <div class="arrow_layer">
        <span class="arrow_top_area">
          <i class="arrow_top_bg"></i>
          <em class="arrow_top"></em>
        </span>
      </div>
    </div>
  </div>
  <script src="../js/jquery-2.1.4.min.js"></script>
  <script src="../resources/layui/layui.js"></script>
  <script src="../js/add.js"></script>
  <script src="../js/plupload.full.min.js"></script>
  <script src="../js/jquery.atwho.js"></script>
  <script src="../js/jquery.caret.js"></script>

  <script type="text/javascript">
    $(function () {
      getTopicClass();
      $.fn.atwho.debug = true

      var names;

      $.ajax({
        url: "http://127.0.0.1:8081/relationController/findFriend.do",
        type: "get",
        async: false,
        data: {
          userId: userId,
        },
        xhrFields: {
          withCredentials: true
        },
        crossDomain: true,
        success: function (data) {
          data = jQuery.parseJSON(data);
          names = data.names;
        },
        error: function (data) {
          if (data.status == 403) {
            window.location.href = "login.html";
          }
        }
      });


      var at_config = {
        at: "@",
        data: names,
        headerTpl: '<div class="atwho-header">选择昵称轻敲空格完成输入</div>',
        insertTpl: '@${name}',
        displayTpl: "<li>${name}</li>",
        startWithSpace: false,
        limit: 10
      }

      $L_content = $('#L_content').atwho(at_config);
    });
  </script>

  <script type="text/javascript">
    var upload_total = 9; //最多上传数量
    var uploader = new plupload.Uploader({ //创建实例的构造方法
      runtimes: 'gears,html5,html4,silverlight,flash', //上传插件初始化选用那种方式的优先级顺序
      browse_button: ['btn', 'btn2'], // 上传按钮
      url: "http://127.0.0.1:8081/uploadController/uploadTopicImage.do", //远程上传地址
      filters: {
        max_file_size: '10mb', //最大上传文件大小（格式100b, 10kb, 10mb, 1gb）
        mime_types: [ //允许文件上传类型
          {
            title: "files",
            extensions: "jpg,png,gif,jpeg"
          }
        ]
      },
      multi_selection: true, //true:ctrl多文件上传, false 单文件上传
      init: {
        FilesAdded: function (up, files) { //文件上传前
          var length_has_upload = $("#ul_pics").children("li").length;
          var uploaded_length = $(".img_common").length;
          console.log(uploaded_length);
          if (files.length >= upload_total - uploaded_length) { //超过上传总数量则隐藏
            $("#local_upload").hide();
          }

          if (uploaded_length >= upload_total - 1) {
            $("#local_upload").hide();
          }
          var li = '';
          plupload.each(files, function (file) { //遍历文件
            if (length_has_upload <= upload_total) {
              li += "<li class='li_upload' id='" + file['id'] +
                "'><div class='progress'><span class='bar'></span><span class='percent'>0%</span></div></li>";
            }
            length_has_upload++;
          });
          var pos = $("#ul_pics").children("li").length - 1;
          $("#ul_pics li:eq(" + pos + ")").before(li);
          uploader.start();
        },
        UploadProgress: function (up, file) { //上传中，显示进度条
          var percent = file.percent;
          $("#" + file.id).find('.bar').css({
            "width": percent + "%"
          });
          $("#" + file.id).find(".percent").text(percent + "%");
        },
        FileUploaded: function (up, file, info) { //文件上传成功的时候触发
          showPhotoUploadBox($('#btn'));
          var uploaded_length = $(".img_common").length;
          if (uploaded_length <= upload_total) {
            var data = eval("(" + info.response + ")"); //解析返回的json数据
            $("#" + file.id).html("<input type='hidden'name='pic[]' value='" + data.url +
              "'/><input type='hidden'name='pic_name[]' value='" + data.url +
              "'/>\n\
<img class='img_common' src='" + data.url +
              "'/><span class='picbg'></span><a class='pic_close' onclick=delPic('" + data.url + "','" + file.id +
              "')></a>");
          }
          showUploadBtn();
        },
        Error: function (up, err) { //上传出错的时候触发
          alert(err.message);
        }
      }
    });
    uploader.init();

    function delPic(pic, file_id) { //删除图片 参数1图片路径  参数2 随机数
      $("#" + file_id).remove();
      showUploadBtn();
    }

    function showUploadBtn() { //是否显示上传按钮
      var uploaded_length = $(".img_common").length;
      $("#uploaded_length").text(uploaded_length);
      var other_length = (upload_total - uploaded_length) > 0 ? upload_total - uploaded_length : 0;
      $("#upload_other").text(other_length);
      var uploaded_length = $(".img_common").length;
      if (uploaded_length >= upload_total) {
        $("#local_upload").hide();
      } else {
        $("#local_upload").show();
      }
    }

    function showPhotoUploadBox(obj) { //显示上传弹出层
      var left = obj.offset().left - 15;
      var top = obj.offset().top + 26;
      $("#photo_upload_box_outside").css({
        "left": left,
        "top": top
      }).show()
    }

    function photo_upload_close() {
      $("#photo_upload_box_outside").fadeOut(500, function () {
        $(".li_upload").remove();
      })
    }
  </script>
  <script src="../js/global.js"></script>
  <script>
    var userId = getUserId();
    window.onload = function () {
      queryMyHeadInfo(userId);
    }

    $('.face').bind({
      click: function (event) {
        if (!$('#sinaEmotion').is(':visible')) {
          $(this).sinaEmotion();
          event.stopPropagation();
        }
      }
    });


    layui.use(['form', 'layedit', 'laydate'], function () {
      var form = layui.form,
        layer = layui.layer,
        layedit = layui.layedit,
        laydate = layui.laydate;

      //自定义验证规则
      form.verify({
        content: function (value) {
          if (value.length > 200) {
            return '内容不能超过200个字';
          }
        },
      });
      //监听提交
      form.on('submit(publish)', function (data) {
        data = data.field;
        var pic = "";
        $('.img_common').each(function () {
          pic += this.src + ',';
        });
        pic = pic.substring(0, pic.length - 1);
        var flag = 0;
        $.ajax({
          url: "http://127.0.0.1:8081/topicController/publishTopic.do",
          async: false,
          data: {
            pic: pic,
            title: data.title,
            content: data.content,
            topicClassId: data.topicClassId,
            authority: data.authority,
            userId: userId
          },
          xhrFields: {
            withCredentials: true
          },
          crossDomain: true,
          error: function (data) {
            if (data.status == 403) {
              window.location.href = "login.html";
            } else {
              layer.alert("请求异常,请重新尝试!", {
                title: '发布失败!',
                time: 2000
              });
            }
          },
          success: function (data) {
            flag = 1;
            var msg = "发布成功!";
            data = jQuery.parseJSON(data);
            if (data.point > 0) {
              msg += "<br>经验值+" + data.point;
            }
            layer.msg(msg, {
              time: 2000
            });
          }
        });
        if (flag == 1) {
          setTimeout(() => {
            window.location.href = "index.html";
          }, 2000);
        }
        return false;

      });

    });


    layui.cache.page = 'jie';
    layui.cache.user = {
      username: '游客',
      uid: -1,
      avatar: '../../res/images/avatar/00.jpg',
      experience: 83,
      sex: '男'
    };
    layui.config({
      version: "3.0.0",
      base: '../js/'
    }).extend({
      fly: 'index'
    }).use('fly');
  </script>

</body>

</html>